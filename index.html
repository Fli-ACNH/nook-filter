<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nookbot Filter Dashboard</title>
    <style>
        /* CSS Variables */
        :root { --green: #2ECC71; --bg: #f5f7fa; --text: #2c3e50; --bell: #F1C40F; --purple: #9b59b6; --red: #e74c3c; --black: #2c3e50; }
        body { background: var(--bg); font-family: 'Segoe UI', system-ui, sans-serif; padding: 20px; color: var(--text); margin: 0; }
        
        /* Layout */
        .container { max-width: 1200px; margin: 20px auto; background: white; border-radius: 12px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); position: relative; }
        h1 { display: flex; align-items: center; gap: 10px; color: #1a252f; margin-top: 0; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #edf2f7; }
        .tab-btn { padding: 12px 24px; border: none; background: none; font-weight: bold; cursor: pointer; color: #7f8c8d; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab-btn.active { color: var(--green); border-bottom-color: var(--green); }

        /* Controls */
        .controls { display: flex; flex-wrap: wrap; gap: 20px; align-items: center; background: #f8f9fb; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .search-box { flex: 1; min-width: 300px; }
        input#searchInput {
            width: 100%; padding: 12px; border: 2px solid #edf2f7; border-radius: 8px; font-size: 15px; outline: none; transition: border-color 0.2s; box-sizing: border-box;
        }
        input#searchInput:focus { border-color: var(--green); }
        
        /* Add Button */
        .add-btn { background: var(--green); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .add-btn:hover { background: #27ae60; }

        /* Modal styling */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 100%; max-width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-content input, .modal-content select { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 8px; box-sizing: border-box; }

        /* Table and Badges (Kept from previous version) */
        table { width: 100%; table-layout: fixed; border-collapse: collapse; display: none; }
        table.active { display: table; }
        th { background: var(--green); color: white; padding: 15px; text-align: left; font-size: 12px; text-transform: uppercase; }
        td { padding: 12px 15px; border-bottom: 1px solid #edf2f7; font-size: 14px; word-wrap: break-word; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; color: white; text-transform: uppercase; display: inline-block; }
        .ban { background: #e74c3c; } .delete { background: #f39c12; }
        .global { background: #27ae60; } .specific { background: #3498db; }
        .malicious { background: #000; color: #ff4757; border: 1px solid #ff4757; }

        /* Pagination & Status */
        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
        .page-btn { background: var(--green); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .page-btn:disabled { background: #ccc; cursor: not-allowed; }
        .status { font-size: 13px; color: #7f8c8d; margin-bottom: 10px; }

        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); width: 100%; max-width: 350px; text-align: center; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="margin-top:0;">üçÉ NookLink Auth</h2>
            <p style="color:#666; font-size:14px;">Enter staff password to access.</p>
            <input type="password" id="passInput" placeholder="Password">
            <button class="add-btn" style="width:100%; justify-content:center; margin-top:10px;" onclick="checkAuth()">Login</button>
        </div>
    </div>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0;">üÜï Add Link Rule</h2>
            <p style="font-size:13px; color:#666;">This will trigger a GitHub Action to update the database.</p>
            <label>Link/URL:</label>
            <input type="text" id="newUrl" placeholder="youtube.com/something">
            <label>Action Type:</label>
            <select id="newType">
                <option value="ALLOW">Whitelist (Global)</option>
                <option value="BLOCK">Blacklist (Delete Only)</option>
                <option value="BAN">Instant Ban (Nuclear)</option>
            </select>
            <label>Staff GitHub Token (Contents Write):</label>
            <input type="password" id="staffGithubToken" placeholder="ghp_xxxxxx">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="add-btn" style="flex:1; justify-content:center;" onclick="submitNewLink()">Save Rule</button>
                <button class="add-btn" style="flex:1; justify-content:center; background:#95a5a6;" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>üçÉ Nookbot Live Filter</h1>
        <div id="stats" class="status">Waiting for login...</div>
        
        <div class="tabs">
            <button id="wordTabBtn" class="tab-btn active" onclick="switchTab('words')">Word Filter</button>
            <button id="linkTabBtn" class="tab-btn" onclick="switchTab('links')">Link Database</button>
        </div>

        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç Search database..." onkeyup="handleSearch()">
            </div>
            <button class="add-btn" id="openAddBtn" style="display:none;" onclick="openModal()">‚ûï Add Rule</button>
        </div>

        <table id="wordTable" class="active">
            <thead><tr><th style="width: 35%;">Word/Phrase</th><th style="width: 10%;">Action</th><th style="width: 15%;">Scope</th><th style="width: 20%;">Exemptions</th><th style="width: 20%;">Details</th></tr></thead>
            <tbody id="wordTableBody"></tbody>
        </table>

        <table id="linkTable">
            <thead><tr><th style="width: 40%;">URL / Domain</th><th style="width: 20%;">Type</th><th style="width: 20%;">Scope</th><th style="width: 20%;">Details</th></tr></thead>
            <tbody id="linkTableBody"></tbody>
        </table>

        <div class="pagination">
            <button id="prevBtn" class="page-btn" onclick="changePage(-1)">Previous</button>
            <span id="pageInfo" class="page-info">Page 1 of 1</span>
            <button id="nextBtn" class="page-btn" onclick="changePage(1)">Next</button>
        </div>
    </div>

    <script>
        const WORD_GIST_ID = 'fd10f054966c358c16a1db28df1faabc'; 
        const LINK_GIST_ID = '570cf10db5dd7418cb7ea428782ed417'; 
        const REPO_OWNER = 'Fli-ACNH'; // YOUR GITHUB USERNAME
        const REPO_NAME = 'nook-filter'; // YOUR REPO NAME
        const PASS = 'acnh'; 
        
        let currentTab = 'words';
        let wordsRaw = [], linksRaw = [], filteredData = [], currentPage = 1;
        const ITEMS_PER_PAGE = 50; 

        function checkAuth() {
            if (document.getElementById('passInput').value.trim() === PASS) {
                document.getElementById('loginOverlay').style.display = 'none';
                loadAllData();
            } else { alert("‚ùå Invalid Password"); }
        }

        async function loadAllData() {
            const stats = document.getElementById('stats');
            stats.innerText = "‚è≥ Loading...";
            try {
                const wRes = await fetch(`https://api.github.com/gists/${WORD_GIST_ID}?t=${Date.now()}`);
                const wData = await wRes.json();
                wordsRaw = JSON.parse(wData.files['banned_words.json'].content);

                const lRes = await fetch(`https://api.github.com/gists/${LINK_GIST_ID}?t=${Date.now()}`);
                const lData = await lRes.json();
                const lJson = JSON.parse(lData.files['links.json'].content);
                
                linksRaw = [
                    ...(lJson.instantBanLinks || []).map(u => ({ url: u, type: 'BAN', global: true, channels: [] })),
                    ...(lJson.blockedLinks || []).map(u => ({ url: u, type: 'BLOCK', global: true, channels: [] })),
                    ...(lJson.links || []).map(u => ({ url: u.url, type: 'ALLOW', global: u.global, channels: u.channels }))
                ];
                stats.innerText = `‚úÖ Connected | ${wordsRaw.length} Words | ${linksRaw.length} Links`;
                switchTab('words');
            } catch (err) { stats.innerText = "‚ùå Load Error."; }
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('wordTabBtn').classList.toggle('active', tab === 'words');
            document.getElementById('linkTabBtn').classList.toggle('active', tab === 'links');
            document.getElementById('wordTable').classList.toggle('active', tab === 'words');
            document.getElementById('linkTable').classList.toggle('active', tab === 'links');
            document.getElementById('openAddBtn').style.display = (tab === 'links') ? 'flex' : 'none';
            handleSearch();
        }

        function openModal() { document.getElementById('addModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('addModal').style.display = 'none'; }

        async function submitNewLink() {
            const url = document.getElementById('newUrl').value.trim();
            const type = document.getElementById('newType').value;
            const token = document.getElementById('staffGithubToken').value.trim();

            if (!url || !token) return alert("Missing URL or GitHub Token!");

            const stats = document.getElementById('stats');
            stats.innerText = "‚è≥ Dispatching update to GitHub Actions...";

            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event_type: 'add_link',
                        client_payload: { data: { type: type, url: url } }
                    })
                });

                if (response.ok) {
                    alert("‚úÖ Success! Update triggered. Wait ~30s and refresh the page.");
                    closeModal();
                } else {
                    const err = await response.json();
                    alert(`‚ùå Failed: ${err.message}`);
                }
            } catch (e) { alert("‚ùå Network Error."); }
        }

        // Search, Render, Page Change logic from previous response...
        function handleSearch() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const source = currentTab === 'words' ? wordsRaw : linksRaw;
            filteredData = source.filter(item => {
                const text = currentTab === 'words' ? (item.word + " " + (item.phrase?.join(' ') || "")) : item.url;
                return text.toLowerCase().includes(term);
            });
            currentPage = 1; render();
        }

        function render() {
            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const pageData = filteredData.slice(start, start + ITEMS_PER_PAGE);
            const wordBody = document.getElementById('wordTableBody');
            const linkBody = document.getElementById('linkTableBody');
            if (currentTab === 'words') {
                wordBody.innerHTML = pageData.map(e => `<tr><td class="word-cell">${e.word} ${e.phrase?.join(' ') || ""}</td><td><span class="badge ${e.autoBan ? 'ban' : 'delete'}">${e.autoBan ? 'Ban' : 'Del'}</span></td><td><span class="badge ${e.global ? 'global' : 'specific'}">${e.global ? 'Global' : 'Spec'}</span></td><td>${e.whitelistedChannels?.length > 0 ? `<span class="badge whitelist-badge">${e.whitelistedChannels.length} EXEMPT</span>` : 'None'}</td><td style="font-size:11px; color:#95a5a6;">${e.global ? 'All' : (e.blockedChannels?.length || 0) + ' Blocked'}</td></tr>`).join('');
            } else {
                linkBody.innerHTML = pageData.map(e => `<tr><td class="word-cell">${e.url}</td><td><span class="badge ${e.type === 'BAN' ? 'malicious' : (e.type === 'BLOCK' ? 'ban' : 'global')}">${e.type}</span></td><td><span class="badge ${e.global ? 'global' : 'specific'}">${e.global ? 'Global' : 'Channel'}</span></td><td style="font-size:11px; color:#95a5a6;">${e.type === 'ALLOW' && !e.global ? e.channels.length + ' Channels' : 'N/A'}</td></tr>`).join('');
            }
            const maxPage = Math.ceil(filteredData.length / ITEMS_PER_PAGE) || 1;
            document.getElementById('pageInfo').innerText = `Page ${currentPage} of ${maxPage}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === maxPage;
        }

        function changePage(dir) { currentPage += dir; render(); window.scrollTo(0,0); }
        document.getElementById('passInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') checkAuth(); });
    </script>
</body>
</html>
