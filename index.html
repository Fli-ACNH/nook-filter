<script>
    const GIST_ID = 'fd10f054966c358c16a1db28df1faabc'; 
    const PASS = 'acnh'; // Your password
    let cachedData = [];

    // Logic: Unified Auth Function
    function checkAuth() {
        const inputField = document.getElementById('passInput');
        const enteredPass = inputField.value.trim(); // .trim() removes accidental spaces

        if (enteredPass === PASS) {
            document.getElementById('loginOverlay').style.display = 'none';
            loadData();
        } else {
            alert("❌ Invalid Password. Please try again.");
            inputField.value = ""; // Clear field on failure
            inputField.focus();
        }
    }

    // Logic: Listen for Enter Key
    document.getElementById('passInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault(); // Prevent page refresh
            checkAuth();
        }
    });

    async function loadData() {
        const stats = document.getElementById('stats');
        stats.innerText = "⏳ Connecting to NookLink...";
        try {
            // Logic: Cache-busting URL to ensure we always get the newest list
            const response = await fetch(`https://api.github.com/gists/${GIST_ID}?t=${Date.now()}`);
            const data = await response.json();
            
            if (!data.files['banned_words.json']) {
                throw new Error("File not found in Gist");
            }

            cachedData = JSON.parse(data.files['banned_words.json'].content);
            
            stats.innerText = `✅ Connected | ${cachedData.length} filters active`;
            renderTable(cachedData);
        } catch (err) {
            stats.innerHTML = '❌ <span style="color:red">Connection Failed. Ensure filename is banned_words.json</span>';
            console.error(err);
        }
    }

    function renderTable(data) {
        const body = document.getElementById('tableBody');
        if (data.length === 0) {
            body.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:50px;">No banned words found in database.</td></tr>';
            return;
        }

        body.innerHTML = data.map(entry => {
            const display = entry.phrase && entry.phrase.length > 0 ? `${entry.word} ${entry.phrase.join(' ')}` : entry.word;
            const isBan = entry.autoBan;
            const isGlobal = entry.global;

            return `
                <tr data-ban="${isBan}" data-global="${isGlobal}">
                    <td class="word-cell">${display}</td>
                    <td><span class="badge ${isBan ? 'ban' : 'delete'}">${isBan ? 'Ban' : 'Del'}</span></td>
                    <td><span class="badge ${isGlobal ? 'global' : 'specific'}">${isGlobal ? 'Global' : 'Specific'}</span></td>
                    <td style="font-size:11px; color:#95a5a6;">${isGlobal ? 'All Channels' : (entry.blockedChannels.length + ' Channels')}</td>
                </tr>`;
        }).join('');
    }

    function runFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const showOnlyBan = document.getElementById('filterBan').checked;
        const showOnlyDel = document.getElementById('filterDel').checked;
        const showOnlySpec = document.getElementById('filterSpec').checked;
        
        const rows = document.querySelectorAll('#tableBody tr');
        
        rows.forEach(row => {
            const wordCell = row.querySelector('.word-cell');
            if (!wordCell) return;

            const text = wordCell.innerText.toLowerCase();
            const isBanRow = row.getAttribute('data-ban') === 'true';
            const isGlobalRow = row.getAttribute('data-global') === 'true';
            
            let visible = text.includes(searchTerm);

            if (showOnlyBan && !isBanRow) visible = false;
            if (showOnlyDel && isBanRow) visible = false;
            if (showOnlySpec && isGlobalRow) visible = false;

            row.style.display = visible ? '' : 'none';
        });
    }

    document.getElementById('searchInput').addEventListener('keyup', runFilters);
</script>
